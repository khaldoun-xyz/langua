<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Learning Assistant</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/theme.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="dark">
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon" style="display: none;">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
    </button>
    <div class="container">
        <div id="evaluation" class="text-center">
            <h1 class="mb-4">Language Learning Assistant</h1>
            <div class="form-group">
                <label for="username">Enter your name:</label>
                <input type="text" class="form-control" id="username" placeholder="Your Name" required>
            </div>
            <div class="form-group">
                <label for="language">Preferred Language:</label>
                <select class="form-control" id="language">
                    <option value="english">English</option>
                    <option value="french">French</option>
                    <option value="german">German</option>
                </select>
            </div>
            <div class="d-flex justify-content-between">
                <button id="start-evaluation" class="btn btn-primary flex-grow-1 mr-2 ">Start Evaluation</button>
                <div style="width: 10px;"></div> 
                <button id="track-progress" class="btn btn-primary flex-grow-1 ml-2">Track Progress</button>
                <button id="restart-conversation" class="btn btn-info mt-2" style="display:none;">Restart Conversation</button>
            </div>
        </div>
        
        <div id="chat-interface" class="mt-4" style="display:none;">
            <div id="chat-box"></div>
            <div class="input-group mt-2">
                <input type="text" id="user-message" class="form-control" placeholder="Type your message..." required>
                <button id="end-conversation" class="btn btn-danger">End Conversation</button>
            </div>
        </div>
        
        <div id="loading-indicator" class="text-center" style="display:none;">
            <strong>Loading...</strong>
        </div>
        <div id="evaluation-message" class="mt-4" style="display:none;"></div>
        <div id="evaluation-result" class="mt-4" style="display:none;"></div>
        <div id="footer" class="mt-5" style="display:none;">
            <hr style="border-color: #d3d3d3; margin: 1;"/>
        </div>
    </div>
    <script>
        $(document).ready(function() {
    let username;
    let language;

    $('#start-evaluation').click(function() {
        username = $('#username').val();
        language = $('#language').val();
        if (username && language) {
            $('#evaluation').addClass('started');
            $('#chat-interface').show().addClass('visible');
            $('#start-evaluation').prop('disabled', true);
            $('#user-message').prop('disabled', false);

            $.ajax({
                url: '/start-evaluation',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ username, language }),
                success: function(data) {
                    if (data.response) {
                        $('#chat-box').append('<div class="chat-message bot"><strong>Groq LLM:</strong> ' + data.response + '</div>');
                        smoothScrollToBottom();
                    }
                },
                error: function(err) {
                    console.error(err);
                    alert('Error starting evaluation. Please try again.');
                }
            });
        } else {
            alert('Please enter your name and preferred language.');
        }
    });

    function sendMessage() {
        const message = $('#user-message').val();
        if (message) {
            $('#chat-box').append(`<div class="message-bubble user-message"><strong>${username}:</strong> ${message}</div>`);
            $('#user-message').val('');
            smoothScrollToBottom();
            
            $.ajax({
                url: '/chat',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ username, message }),
                success: function(data) {
                    if (data.response) {
                        $('#chat-box').append(`<div class="message-bubble bot-message"><strong>Groq LLM:</strong> ${data.response}</div>`);
                        smoothScrollToBottom();
                    }
                },
                error: function(err) {
                    console.error(err);
                    alert('Error sending message. Please try again.');
                }
            });
        }
    }

    $('#user-message').keypress(function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

    $('#end-conversation').click(function() {
        $('#loading-indicator').show();
        $.ajax({
            url: '/end-conversation',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ username }),
            success: function(data) {
                $('#loading-indicator').hide();
                $('#evaluation-message').text(`You interacted ${data.interaction_count} times over a duration of ${data.total_duration} seconds.`).show();
                if (data.evaluation) {
                    $('#evaluation-result').html('<strong>Evaluation Result:</strong><br>' + data.evaluation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>')).show();
                }
                $('#start-evaluation').remove();
                $('#restart-conversation').show(); 
                $('html, body').animate({
                    scrollTop: $('#evaluation-result').offset().top
                }, 1000);
            },
            error: function(err) {
                $('#loading-indicator').hide();
                console.error(err);
                alert('Error ending conversation. Please try again.');
            }
        });
        
        $('#user-message').prop('disabled', true);
        $('#end-conversation').prop('disabled', true);
    });

    $('#restart-conversation').click(function() {
        language = $('#language').val(); 
        $('#evaluation-message').hide();
        $('#evaluation-result').hide();
        $('#footer').hide(); 
        $('#chat-box').empty(); 
        $('#restart-conversation').hide();
        
        $.ajax({
            url: '/restart-conversation',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ username, language }), 
            success: function(data) {
                $('#user-message').prop('disabled', false);
                $('#end-conversation').prop('disabled', false);
                $('#chat-interface').show();
                $('#loading-indicator').hide(); 
                if (data.response) {
                    $('#chat-box').append('<div class="chat-message bot"><strong>Groq LLM:</strong> ' + data.response + '</div>');
                    smoothScrollToBottom();
                }
            },
            error: function(err) {
                console.error(err);
                alert('Error restarting conversation. Please try again.');
            }
        });
    });

    $('#track-progress').click(function() {
        window.location.href = '/track_progress';
    });


    function smoothScrollToBottom() {
        $('#chat-box').animate({
            scrollTop: $('#chat-box')[0].scrollHeight
        }, 500);
    }

    const themeToggle = document.getElementById('theme-toggle');
    const sunIcon = themeToggle.querySelector('.sun-icon');
    const moonIcon = themeToggle.querySelector('.moon-icon');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark');
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'block';
    }
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        sunIcon.style.display = isDark ? 'none' : 'block';
        moonIcon.style.display = isDark ? 'block' : 'none';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
});
    </script>
</body>
</html>