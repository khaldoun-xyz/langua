<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groq LLM Chat Interface</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        html, body {
            min-height: calc(100vh + 5cm); /* Ensures the page is at least 5cm longer than the viewport height */
        }
        #chat-box {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #evaluation-result {
            border-top: 1px solid #ccc;
            padding-top: 10px;
            margin-top: 10px;
        }
        #loading-indicator {
            display: none;
            margin-top: 10px;
        }
        #footer {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Groq LLM Chat Interface</h1>
        <div id="evaluation">
            <div class="form-group">
                <label for="username">Enter your name:</label>
                <input type="text" class="form-control" id="username" placeholder="Your Name" required>
            </div>
            <div class="form-group">
                <label for="language">Preferred Language:</label>
                <select class="form-control" id="language">
                    <option value="english">English</option>
                    <option value="french">French</option>
                    <option value="german">German</option>
                </select>
            </div>
            <button id="start-evaluation" class="btn btn-primary">Start Evaluation</button>
            <button id="track-progress" class="btn btn-primary">Track Progress</button>
        </div>
        
        <div id="chat-interface" class="mt-4" style="display:none;">
            <h3>Chat Interface</h3>
            <div id="chat-box"></div>
            <input type="text" id="user-message" class="form-control" placeholder="Type your message..." required>
            <button id="end-conversation" class="btn btn-danger mt-2">End Conversation</button>
            <button id="restart-conversation" class="btn btn-info mt-2" style="display:none;">Restart Conversation</button>
        </div>

        <div id="evaluation-message" class="mt-4" style="display:none;"></div>
        <div id="evaluation-result" class="mt-4" style="display:none;"></div>
        <div id="footer" class="mt-5" style="display:none;">
            <hr style="border-color: #d3d3d3; margin: 1;"/>
        </div>
        <div id="loading-indicator" class="text-center">
            <strong>Loading...</strong>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let username;
            let language;

            $('#start-evaluation').click(function() {
                username = $('#username').val();
                language = $('#language').val();
                if (username && language) {
                    $('#chat-interface').show();
                    $('#start-evaluation').prop('disabled', true);
                    $('#user-message').prop('disabled', false);
                } else {
                    alert('Please enter your name and preferred language.');
                }
            });

            function sendMessage() {
                const message = $('#user-message').val();
                if (message) {
                    $('#chat-box').append(`<div><strong>${username}:</strong> ${message}</div>`);
                    $('#user-message').val('');
                    
                    // Scroll to the bottom of the chat box
                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);

                    $.ajax({
                        url: '/chat',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ username, message, language }),
                        success: function(data) {
                            if (data.response) {
                                $('#chat-box').append('<div><strong>Groq LLM:</strong> ' + data.response + '</div>');
                                
                                // Scroll to the bottom of the chat box
                                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                            }
                        },
                        error: function(err) {
                            console.error(err);
                            alert('Error sending message. Please try again.');
                        }
                    });
                }
            }

            $('#user-message').keypress(function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });

            $('#end-conversation').click(function() {
                $('#loading-indicator').show();
                $.ajax({
                    url: '/end-conversation',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ username, language }),
                    success: function(data) {
                        $('#loading-indicator').hide(); // Hide loading indicator
                        $('#evaluation-message').text(`You interacted ${data.interaction_count} times over a duration of ${data.total_duration} seconds.`).show();
                        // Here, you can also show a message that the evaluation is being processed
                        if (data.evaluation) {
                            $('#evaluation-result').html('<strong>Evaluation Result:</strong><br>' + data.evaluation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>'));
                            $('#evaluation-result').show();
                            $('#footer').show(); 
                        }
                    },
                    error: function(err) {
                        $('#loading-indicator').hide(); // Hide loading indicator
                        console.error(err);
                        alert('Error ending conversation. Please try again.');
                    }
                });
                
                $('#user-message').prop('disabled', true);
                $('#end-conversation').prop('disabled', true);
                $('#restart-conversation').show();
            });

            $('#restart-conversation').click(function() {
                $('#chat-box').empty();
                $('#evaluation-message').hide();
                $('#evaluation-result').hide();
                $('#footer').hide(); 
                $('#restart-conversation').hide();
                $('#user-message').prop('disabled', false);
                $('#end-conversation').prop('disabled', false);
                $('#chat-interface').show();
                startTime = new Date();
                interactionCount = 0;
                $('#chat-box').append('<div>New conversation started at: ' + startTime.toLocaleString() + '</div>');
            });

            $('#track-progress').click(function() {
                window.location.href = '/track_progress';
            });
        });
    </script>
</body>
</html>